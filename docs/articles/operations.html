<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operational Forecasts • National Water Model</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../bootstrap.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../mikepkgdown.css" rel="stylesheet">
<meta property="og:title" content="Operational Forecasts">
<meta property="og:description" content="nwmTools">
<meta property="og:image" content="https://github.com/mikejohnson51/nwmHistoric/logo.svg">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
                                                                          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
                                                                            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
                                                                              <![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
              <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                  </button>
                  
                  <div class="navbar-brand-container">
                    <a class="navbar-brand" href="../index.html">nwmTools</a>
                      <div class="info">
                        <span class="partof">National Water Model</span>
                          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
                            </div>
                              </div>
                              </div>
                              <div id="navbar" class="navbar-collapse collapse">
                                <ul class="nav navbar-nav navbar-left">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/api.html">Historic Records</a>
    </li>
    <li>
      <a href="../articles/discovery.html">Feature Discovery</a>
    </li>
    <li>
      <a href="../articles/operations.html">Operational Forecasts</a>
    </li>
    <li>
      <a href="../articles/time.html">Time Aggregation{s}</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
                                </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mikejohnson51/nwmTools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
                                </ul>
</div>
<!--/.nav-collapse -->
                                          </div>
<!--/.container -->
                                          </div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Operational Forecasts</h1>
                        <h4 data-toc-skip class="author"><a href="mailto:mikecp11@gmail.com" class="email">mikecp11@gmail.com</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mikejohnson51/nwmTools/blob/HEAD/vignettes/operations.Rmd" class="external-link"><code>vignettes/operations.Rmd</code></a></small>
      <div class="hidden name"><code>operations.Rmd</code></div>

    </div>

    
    
<p>These are some basic examples illustrating how to work with operational NWM streamflow forecasts. The nature of the NWM means that each hour of data is stored in a separate file. To evaluate streamflow for a COMID, or set of COMIDs, through time, a number of of steps are needed which include:</p>
<ol style="list-style-type: decimal">
<li>Identifying files,</li>
<li>Downloading said files,</li>
<li>Merging/Pivoting the files,</li>
<li>Extracting data by COMID</li>
</ol>
<div class="section level3">
<h3 id="identify-and-download-files">Identify and Download files<a class="anchor" aria-label="anchor" href="#identify-and-download-files"></a>
</h3>
<p>Here we identify the most current forecasts available on NOMADs with <code>get_nomads_filelist</code>, and then proceed to download them to a temporary directory with <code>download_nomads</code>. Specifically we are looking at the <em>4th</em> ensemble member of the <em>medium range</em> configuration and we limit the data to the first <em>20 timesteps</em>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">urls</span>     <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/get_nomads_filelist.html">get_nomads_filelist</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"medium_range"</span>, num <span class="op">=</span> <span class="fl">20</span>,  ensemble <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu">glimpse</span><span class="op">(</span><span class="va">urls</span><span class="op">)</span> 

<span class="va">in_files</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/download_nomads.html">download_nomads</a></span><span class="op">(</span><span class="va">urls</span>, dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu">glimpse</span><span class="op">(</span><span class="va">in_files</span><span class="op">)</span> </code></pre></div>
</div>
<div class="section level3">
<h3 id="mergingpivoting-our-files">Merging/Pivoting our files<a class="anchor" aria-label="anchor" href="#mergingpivoting-our-files"></a>
</h3>
<p>After downloading files, we want to merge them into a single file. <code>nwmTools</code> offers a number of ways to do this. The preferred way is if you have <a href="http://nco.sourceforge.net/" class="external-link">NCO</a> install, otherwise there is a RNetCDF variant available. There is also an option to pivot the resulting NetCDF (only available with NCO), such that the data is time eries oriented.</p>
<p>These three options are highlighted below:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nco_pivot</span>     <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".nc"</span><span class="op">)</span>
<span class="va">nco_nopivot</span>   <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".nc"</span><span class="op">)</span>
<span class="va">r_nopivot</span>     <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".nc"</span><span class="op">)</span>

<span class="co"># Use NCO and pivot (default)</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="../reference/create_nwm_nc.html">create_nwm_nc</a></span><span class="op">(</span>fileList <span class="op">=</span> <span class="va">in_files</span>, dstfile <span class="op">=</span> <span class="va">nco_pivot</span>, purge <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  12.845   6.345  21.416</span>

<span class="co"># Use NCO but do not pivot</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="../reference/create_nwm_nc.html">create_nwm_nc</a></span><span class="op">(</span>fileList <span class="op">=</span> <span class="va">in_files</span>, dstfile <span class="op">=</span> <span class="va">nco_nopivot</span>, pivot <span class="op">=</span> <span class="cn">FALSE</span>, purge <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  12.393   5.351  18.989</span>

<span class="co"># Use RNetCDF</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="../reference/create_nwm_nc.html">create_nwm_nc</a></span><span class="op">(</span>fileList <span class="op">=</span> <span class="va">in_files</span>, dstfile  <span class="op">=</span> <span class="va">r_nopivot</span>, nco <span class="op">=</span> <span class="cn">FALSE</span>, purge <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   6.780   0.767   7.699</span></code></pre></div>
<p>Lets look at the size of the resulting files?</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Raw files</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="va">in_files</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e6</span>
<span class="co">#&gt; [1] 293.9361</span>
<span class="co"># Pivoted NCO file</span>
<span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="va">nco_pivot</span><span class="op">)</span>    <span class="op">/</span> <span class="fl">1e6</span>
<span class="co">#&gt; [1] 14.60686</span>
<span class="co"># Non Pivoted NCO file</span>
<span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="va">nco_nopivot</span><span class="op">)</span>  <span class="op">/</span> <span class="fl">1e6</span>
<span class="co">#&gt; [1] 25.28378</span>
<span class="co"># R-based file, no pivot</span>
<span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="va">r_nopivot</span><span class="op">)</span>    <span class="op">/</span> <span class="fl">1e6</span>
<span class="co">#&gt; [1] 57.01232</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pivoting">Pivoting?<a class="anchor" aria-label="anchor" href="#pivoting"></a>
</h3>
<p>So what does it mean to have a pivoted file?</p>
<p>All NetCDF variables are defined by dimensions. In our case streamflow is a 2D variable defined by the number of time steps (time dimension), and the number of COMIDs (feature_id dimension). Subsets of streamflow can be extracted from this 2D matrix by defining intervals along these dimensions. The order in which the data will be returned is with the last dimension varying fastest. So, if we want to optimize our files for time series access the dimension order should be [feature_id, time], if we want them optimized for space-based query the the dimension order should be [time, feature_id]</p>
<p>First lets looks at the dimensions in the NetCDF files (they are the same across all three variants.)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ncmeta</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncmeta/man/nc_dims.html" class="external-link">nc_dims</a></span><span class="op">(</span><span class="va">nco_pivot</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span>
<span class="co">#&gt;      id name        length unlim</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     0 feature_id 2<span style="text-decoration: underline;">776</span>738 TRUE </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1 time            20 FALSE</span>
<span class="fu">ncmeta</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncmeta/man/nc_dims.html" class="external-link">nc_dims</a></span><span class="op">(</span><span class="va">nco_nopivot</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span>
<span class="co">#&gt;      id name        length unlim</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     0 feature_id 2<span style="text-decoration: underline;">776</span>738 FALSE</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1 time            20 TRUE</span>
<span class="fu">ncmeta</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncmeta/man/nc_dims.html" class="external-link">nc_dims</a></span><span class="op">(</span><span class="va">r_nopivot</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span>
<span class="co">#&gt;      id name        length unlim</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     0 feature_id 2<span style="text-decoration: underline;">776</span>738 FALSE</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     1 time            20 TRUE</span></code></pre></div>
<p>Note that <code>feature_id</code> is the 0 dimension, and <code>time</code> is the 1 dimension where the value is simply the ID. We also note that we have the ~2.7 million reaches over 20 time slices. To see how or pivoted/non-pivoted files are structured we can look at the grids.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ncmeta</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncmeta/man/nc_grids.html" class="external-link">nc_grids</a></span><span class="op">(</span><span class="va">nco_pivot</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span>
<span class="co">#&gt;   grid  ndims variables        nvars</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> D1,D0     2 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> D0        1 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> D1        1 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="fu">ncmeta</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncmeta/man/nc_grids.html" class="external-link">nc_grids</a></span><span class="op">(</span><span class="va">nco_nopivot</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span>
<span class="co">#&gt;   grid  ndims variables        nvars</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> D0,D1     2 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> D0        1 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> D1        1 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="fu">ncmeta</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncmeta/man/nc_grids.html" class="external-link">nc_grids</a></span><span class="op">(</span><span class="va">r_nopivot</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span>
<span class="co">#&gt;   grid  ndims variables        nvars</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> D0,D1     2 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> D0        1 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> D1        1 <span style="color: #949494;">&lt;tibble [1 × 1]&gt;</span>     1</span></code></pre></div>
<p>So, the NCO pivot file is structured [D0,D1] or [feature_id, time], while the non-pivoted files are stored [D1,D0] or [time, feature_id]. So in addition to the decreased file size, the pivoting also sets up the <code>nco_pivot</code> file for faster data extraction.</p>
</div>
<div class="section level3">
<h3 id="extraction">Extraction<a class="anchor" aria-label="anchor" href="#extraction"></a>
</h3>
<p>Now the fun part! Getting data out of these files.</p>
<p>Since our resulting NetCDF can be formatted differently depending on method used, and subsetting is a repetitive task prone to error, <code>nwmTools</code> offers a <code>extract_nwm</code> function that works from a file and set of COMID(s). For example, lets extract the time series from all three files for COMID-102900.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">Q1</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/extract_nwm.html">extract_nwm</a></span><span class="op">(</span><span class="va">nco_pivot</span>, comids   <span class="op">=</span> <span class="fl">102900</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.042   0.019   0.066</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">Q2</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/extract_nwm.html">extract_nwm</a></span><span class="op">(</span><span class="va">nco_nopivot</span>, comids <span class="op">=</span> <span class="fl">102900</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.037   0.020   0.058</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">Q3</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/extract_nwm.html">extract_nwm</a></span><span class="op">(</span><span class="va">r_nopivot</span>, comids   <span class="op">=</span> <span class="fl">102900</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.053   0.006   0.059</span>

<span class="co"># Are they all the same?</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">Q1</span><span class="op">$</span><span class="va">values</span>, <span class="va">Q2</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">Q1</span><span class="op">$</span><span class="va">values</span>, <span class="va">Q3</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Q1</span><span class="op">$</span><span class="va">dateTime</span>, <span class="va">Q1</span><span class="op">$</span><span class="va">values</span>, ylab <span class="op">=</span> <span class="st">"Flow (cms)"</span>,  xlab <span class="op">=</span> <span class="st">"DateTime"</span><span class="op">)</span></code></pre></div>
<p><img src="operations_files/figure-html/one-comid-1.png" width="576"></p>
<p>The same process can be employed for a set of COMIDs</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get 1000 random COMIDs...</span>
<span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu">var.get.nc</span><span class="op">(</span><span class="fu">open.nc</span><span class="op">(</span><span class="va">nco_pivot</span><span class="op">)</span>, <span class="st">"feature_id"</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">Q4</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/extract_nwm.html">extract_nwm</a></span><span class="op">(</span><span class="va">nco_pivot</span>, comids <span class="op">=</span> <span class="va">test</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   1.394   0.132   1.659</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">Q5</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/extract_nwm.html">extract_nwm</a></span><span class="op">(</span><span class="va">nco_nopivot</span>, comids <span class="op">=</span> <span class="va">test</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   1.775   0.105   1.906</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">Q6</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/extract_nwm.html">extract_nwm</a></span><span class="op">(</span><span class="va">r_nopivot</span>, comids <span class="op">=</span> <span class="va">test</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   2.939   0.171   3.187</span>

<span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">Q4</span><span class="op">$</span><span class="va">values</span>, <span class="va">Q5</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">Q4</span><span class="op">$</span><span class="va">values</span>, <span class="va">Q6</span><span class="op">$</span><span class="va">values</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="putting-it-all-together">Putting it all together …<a class="anchor" aria-label="anchor" href="#putting-it-all-together"></a>
</h3>
<p>Lets put this all together in an example that (1) defines an area, (2) identifies the needed COMIDs, (3) downloads a sets of forecast files, (4) formats them and (5) extracts the needed time series. Here, we use a shortcut in <code>create_nwm_nc</code> in which the definition of files and the download are defined as parameters rather then passed as a set of files.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define and area, get NHDflowlines, and isolate the COMID</span>
<span class="va">AOI</span> <span class="op">=</span>  <span class="fu"><a href="https://usgs-r.github.io/nhdplusTools/reference/get_nhdplus.html" class="external-link">get_nhdplus</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/AOI/man/aoi_get.html" class="external-link">aoi_get</a></span><span class="op">(</span><span class="st">"Fort Collins"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">comid</span>

<span class="co"># Define, download, format, purge, extract!</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">nwm</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_nwm_nc.html">create_nwm_nc</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"medium_range"</span>, 
                      num <span class="op">=</span> <span class="fl">10</span>,  
                      ensemble <span class="op">=</span> <span class="fl">2</span>,
                      dstfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".nc"</span><span class="op">)</span>,
                      purge <span class="op">=</span> <span class="cn">TRUE</span>,
                      quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="va">forecast</span> <span class="op">=</span> <span class="fu"><a href="../reference/extract_nwm.html">extract_nwm</a></span><span class="op">(</span><span class="va">nwm</span>, comids <span class="op">=</span> <span class="va">AOI</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   7.330   4.300  15.119</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualize">Visualize!<a class="anchor" aria-label="anchor" href="#visualize"></a>
</h3>
<p>So what do the flows in Boulder look like in the forcasted future?</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">forecast</span>, 
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dateTime</span>, y <span class="op">=</span> <span class="va">values</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">comid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Flow (cms)"</span>, 
       title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">dateTime</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">" to "</span><span class="op">)</span>,
       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">comid</span><span class="op">)</span><span class="op">)</span>, <span class="st">"COMIDs"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<p><img src="operations_files/figure-html/viz-1.png" width="576"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer></footer>
</div>

  


  

  </body>
</html>
